package main

import (
	"crypto/sha256"
	"fmt"
	"math/big"
	"os"
	"strconv"
	"strings"

	"github.com/ethereum/go-ethereum/common"
	"github.com/ethereum/go-ethereum/common/hexutil"
	"github.com/ethereum/go-ethereum/core/rawdb"
	"github.com/ethereum/go-ethereum/core/state"
	"github.com/ethereum/go-ethereum/core/tracing"
	"github.com/ethereum/go-ethereum/core/types"
	"github.com/ethereum/go-ethereum/core/vm"
	"github.com/ethereum/go-ethereum/ethdb/leveldb"
	"github.com/ethereum/go-ethereum/params"
	"github.com/ethereum/go-ethereum/triedb"
	"github.com/holiman/uint256"
	"github.com/sharding-experiment/sharding/config"
)

// Bytecodes for the contracts (compiled with Solidity 0.8.23, EVM version paris - no PUSH0)

const trainBookingBytecode = "0x608060405234801561001057600080fd5b50610486806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c8063485cc4391461005c5780634a6e480e1461007a57806350b447121461008457806387a362a4146100b457806394c2c24f146100d0575b600080fd5b6100646100ee565b60405161007191906101ff565b60405180910390f35b6100826100f4565b005b61009e6004803603810190610099919061024b565b61013c565b6040516100ab91906102b9565b60405180910390f35b6100ce60048036038101906100c99190610300565b610173565b005b6100d86101e0565b6040516100e591906101ff565b60405180910390f35b60005481565b61012c6000541061013a576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101319061038a565b60405180910390fd5b565b60018161012c811061014d57600080fd5b016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b806001600080815480929190610188906103d9565b9190505561012c811061019e5761019d610421565b5b0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b61012c81565b6000819050919050565b6101f9816101e6565b82525050565b600060208201905061021460008301846101f0565b92915050565b600080fd5b610228816101e6565b811461023357600080fd5b50565b6000813590506102458161021f565b92915050565b6000602082840312156102615761026061021a565b5b600061026f84828501610236565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006102a382610278565b9050919050565b6102b381610298565b82525050565b60006020820190506102ce60008301846102aa565b92915050565b6102dd81610298565b81146102e857600080fd5b50565b6000813590506102fa816102d4565b92915050565b6000602082840312156103165761031561021a565b5b6000610324848285016102eb565b91505092915050565b600082825260208201905092915050565b7f4e6f206d6f7265207469636b657420617661696c61626c650000000000000000600082015250565b600061037460188361032d565b915061037f8261033e565b602082019050919050565b600060208201905081810360008301526103a381610367565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006103e4826101e6565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610416576104156103aa565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea26469706673582212200d53faf81380770c120ebaf976a0ec6ffb367d709138681b4c7e8f951e98dd2c64736f6c63430008170033"

const hotelBookingBytecode = "0x608060405234801561001057600080fd5b50610486806100206000396000f3fe608060405234801561001057600080fd5b50600436106100575760003560e01c80630e424b2b1461005c578063165fcb2d14610066578063" +
	"1bae0ac814610082578063427eaabb146100b2578063463f5ce2146100d0575b600080fd5b6100646100ee565b005b610080600480360381019061007b9190610249565b610136565b005b61009c600480360381019061009791906102ac565b6101a3565b6040516100a991906102e8565b60405180910390f35b6100ba6101da565b6040516100c79190610312565b60405180910390f35b6100d86101e0565b6040516100e59190610312565b60405180910390f35b61012c60005410610134576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161012b9061038a565b60405180910390fd5b565b80600160008081548092919061014b906103d9565b9190505561012c811061016157610160610421565b5b0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b60018161012c81106101b457600080fd5b016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b61012c81565b60005481565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610216826101eb565b9050919050565b6102268161020b565b811461023157600080fd5b50565b6000813590506102438161021d565b92915050565b60006020828403121561025f5761025e6101e6565b5b600061026d84828501610234565b91505092915050565b6000819050919050565b61028981610276565b811461029457600080fd5b50565b6000813590506102a681610280565b92915050565b6000602082840312156102c2576102c16101e6565b5b60006102d084828501610297565b91505092915050565b6102e28161020b565b82525050565b60006020820190506102fd60008301846102d9565b92915050565b61030c81610276565b82525050565b60006020820190506103276000830184610303565b92915050565b600082825260208201905092915050565b7f4e6f206d6f726520726f6f6d20617661696c61626c6500000000000000000000600082015250565b600061037460168361032d565b915061037f8261033e565b602082019050919050565b600060208201905081810360008301526103a381610367565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006103e482610276565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610416576104156103aa565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea2646970667358221220a6262d5345bc233bbba4707f73e4c2641d1f986897a4d6ac5c8e63fe0da4ef3764736f6c63430008170033"

// Generic booking contract bytecode (PlaneBooking, TaxiBooking, YachtBooking, MovieBooking, RestaurantBooking)
// These all have the same interface: checkAvailability(), book(address), getBookedCount()
const genericBookingBytecode = "0x608060405234801561001057600080fd5b506104b8806100206000396000f3fe608060405234801561001057600080fd5b50600436106100625760003560e01c80631dab301e14610067578063537d22bd14610097578063" +
	"7ca81460146100a157806394c2c24f146100bd578063a7e67475146100db578063eab22a8d146100f9575b600080fd5b610081600480360381019061007c9190610253565b610117565b60405161008e91906102c1565b60405180910390f35b61009f61014e565b005b6100bb60048036038101906100b69190610308565b610196565b005b6100c5610203565b6040516100d29190610344565b60405180910390f35b6100e3610209565b6040516100f09190610344565b60405180910390f35b610101610212565b60405161010e9190610344565b60405180910390f35b60018161012c811061012857600080fd5b016000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b61012c60005410610194576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161018b906103bc565b60405180910390fd5b565b8060016000808154809291906101ab9061040b565b9190505561012c81106101c1576101c0610453565b5b0160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b61012c81565b60008054905090565b60005481565b600080fd5b6000819050919050565b6102308161021d565b811461023b57600080fd5b50565b60008135905061024d81610227565b92915050565b60006020828403121561026957610268610218565b5b60006102778482850161023e565b91505092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006102ab82610280565b9050919050565b6102bb816102a0565b82525050565b60006020820190506102d660008301846102b2565b92915050565b6102e5816102a0565b81146102f057600080fd5b50565b600081359050610302816102dc565b92915050565b60006020828403121561031e5761031d610218565b5b600061032c848285016102f3565b91505092915050565b61033e8161021d565b82525050565b60006020820190506103596000830184610335565b92915050565b600082825260208201905092915050565b7f4e6f206d6f726520736561747320617661696c61626c65000000000000000000600082015250565b60006103a660178361035f565b91506103b182610370565b602082019050919050565b600060208201905081810360008301526103d581610399565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006104168261021d565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610448576104476103dc565b5b600182019050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea26469706673582212209c33792f3f6aa3c299335667835e7bd4093bfc3ea0b5a35ea1c46af2b5432bc164736f6c63430008170033"

// TravelAgency bytecode with 7-argument constructor (train, hotel, plane, taxi, yacht, movie, restaurant)
const travelAgencyBytecode = "0x6101606040523480156200001257600080fd5b5060405162002e1b38038062002e1b83398181016040528101906200003891906200021e565b8673ffffffffffffffffffffffffffffffffffffffff166080817" +
	"3ffffffffffffffffffffffffffffffffffffffff16815250508573ffffffffffffffffffffffffffffffffffffffff1660a08173ffffffffffffffffffffffffffffffffffffffff16815250508473ffffffffffffffffffffffffffffffffffffffff1660c08173ffffffffffffffffffffffffffffffffffffffff16815250508373ffffffffffffffffffffffffffffffffffffffff1660e08173ffffffffffffffffffffffffffffffffffffffff16815250508273ffffffffffffffffffffffffffffffffffffffff166101008173ffffffffffffffffffffffffffffffffffffffff16815250508173ffffffffffffffffffffffffffffffffffffffff166101208173ffffffffffffffffffffffffffffffffffffffff16815250508073ffffffffffffffffffffffffffffffffffffffff166101408173ffffffffffffffffffffffffffffffffffffffff168152505050505050505050620002d1565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620001e682620001b9565b9050919050565b620001f881620001d9565b81146200020457600080fd5b50565b6000815190506200021881620001ed565b92915050565b600080600080600080600060e0888a03121562000240576200023f620001b4565b5b6000620002508a828b0162000207565b9750506020620002638a828b0162000207565b9650506040620002768a828b0162000207565b9550506060620002898a828b0162000207565b94505060806200029c8a828b0162000207565b93505060a0620002af8a828b0162000207565b92505060c0620002c28a828b0162000207565b91505092959891949750929550565b60805160a05160c05160e051610100516101205161014051612a16620004056000396000818161039501528181610d5301528181610d9201528181610ee201528181611f5301526120a001526000818161032d0152818161043b01528181610bd701528181610c1601528181611ca70152611df40152600081816102c50152818161045f01528181610a5b01528181610a9a015281816119fb0152611b4801526000818161025d015281816104e4015281816108df0152818161091e0152818161174f015261189c0152600081816101f501528181610763015281816107a201528181610ebe015281816114a301526115f001526000818161062701528181610f2a0152818161109d015261134401526000818161050b01528181610f0601528181610f5001526111ea0152612a166000f3fe608060405234801561001057600080fd5b506004361061009e5760003560e01c80636e1ed9d8116100665780636e1ed9d81461012357806372a36fc51461015357806381fe644d1461017157806384e786791461018f5780639af6c63a146101ad5761009e565b80632990672c146100a35780633761653e146100bf5780633bc29004146100dd5780635710ddcd146100fb5780636c153bf914610105575b600080fd5b6100bd60048036038101906100b89190612238565b6101cb565b005b6100c7610439565b6040516100d491906122f4565b60405180910390f35b6100e561045d565b6040516100f291906122f4565b60405180910390f35b610103610481565b005b61010d6104e2565b60405161011a91906122f4565b60405180910390f35b61013d60048036038101906101389190612238565b610506565b60405161014a919061231e565b60405180910390f35b61015b610ebc565b60405161016891906122f4565b60405180910390f35b610179610ee0565b60405161018691906122f4565b60405180910390f35b610197610f04565b6040516101a491906122f4565b60405180910390f35b6101b5610f28565b6040516101c291906122f4565b60405180910390f35b6101d3610f4c565b848015610" +
	"22d5750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b1561023b5761023a61149f565b5b8380156102955750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b156102a3576102a261174b565b5b8280156102fd5750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b1561030b5761030a6119f7565b5b8180156103655750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b1561037357610372611ca3565b5b8080156103cd5750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b156103db576103da611f4f565b5b60016000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505050505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000081565b610489610f4c565b60016000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff021916908315150217905550565b7f000000000000000000000000000000000000000000000000000000000000000081565b6000807f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f4a6e480e000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516105d091906123aa565b600060405180830381855afa9150503d806000811461060b576040519150601f19603f3d011682016040523d82523d6000602084013e610610565b606091505b50508091505080610625576000915050610eb3565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f0e424b2b000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516106ec91906123aa565b600060405180830381855afa9150503d8060008114610727576040519150601f19603f3d011682016040523d82523d6000602084013e61072c565b606091505b50508091505080610741576000915050610eb3565b86801561079b5750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b156108bd577f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161086791906123aa565b600060405180830381855afa9150503d80600081146108a2576040519150601f19603f3d011682016040523d82523d6000602084013e6108a7565b606091505b505080915050806108bc576000915050610eb3565b5b8580156109175750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b15610a39577f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516109e391906123aa565b600060405180830381855afa9150503d8060008114610a1e576040519150601f19603f3d011682016040523d82523d6000602084013e610a23565b606091505b50508091505080610a38576000915050610eb3565b5b848015610a935750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b15610bb5577f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610b5f91906123aa565b600060405180830381855afa9150503d8060008114610b9a576040519150601f19603f3d011682016040523d82523d6000602084013e610b9f565b606091505b50508091505080610bb4576000915050610eb3565b5b838015610c0f5750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b15610d31577f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610cdb91906123aa565b600060405180830381855afa9150503d8060008114610d16576040519150601f19603f3d011682016040523d82523d6000602084013e610d1b565b606091505b50508091505080610d30576000915050610eb3565b5b828015610d8b5750600073ffffffffffffffffffffffffffffffffffffffff167f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1614155b15610ead577f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051610e5791906123aa565b600060405180830381855afa9150503d8060008114610e92576040519150601f19603f3d011682016040523d82523d6000602084013e610e97565b606091505b50508091505080610eac576000915050610eb3565b5b60019150505b95945050505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000081565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f4a6e480e000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161101591906123aa565b600060405180830381855afa9150503d8060008114611050576040519150601f19603f3d011682016040523d82523d6000602084013e611055565b606091505b5050809150508061109b576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016110929061241e565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f0e424b2b000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161116291906123aa565b600060405180830381855afa9150503d806000811461119d576040519150601f19603f3d011682016040523d82523d6000602084013e6111a2565b606091505b505080915050806111e8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016111df9061248a565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163360405160240161123091906122f4565b6040516020818303038152906040527f87a362a4000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516112ba91906123aa565b6000604051808303816000865af19150503d80600081146112f7576040519150601f19603f3d011682016040523d82523d6000602084013e6112fc565b606091505b50508091505080611342576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611339906124f6565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163360405160240161138a91906122f4565b6040516020818303038152906040527f165fcb2d000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161141491906123aa565b6000604051808303816000865af19150503d8060008114611451576040519150601f19603f3d011682016040523d82523d6000602084013e611456565b606091505b5050809150508061149c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161149390612562565b60405180910390fd5b50565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161156891906123aa565b600060405180830381855afa9150503d80600081146115a3576040519150601f19603f3d011682016040523d82523d6000602084013e6115a8565b606091505b505080915050806115ee576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016115e5906125ce565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163360405160240161163691906122f4565b6040516020818303038152906040527f7ca81460000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff83818316178352505050506040516116c091906123aa565b6000604051808303816000865af19150503d80600081146116fd576040519150601f19603f3d011682016040523d82523d6000602084013e611702565b606091505b50508091505080611748576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161173f9061263a565b60405180910390fd5b50565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161181491906123aa565b600060405180830381855afa9150503d806000811461184f576040519150601f19603f3d011682016040523d82523d6000602084013e611854565b606091505b5050809150508061189a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611891906126a6565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff16336040516024016118e291906122f4565b6040516020818303038152906040527f7ca81460000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161196c91906123aa565b6000604051808303816000865af19150503d80600081146119a9576040519150601f19603f3d011682016040523d82523d6000602084013e6119ae565b606091505b505080915050806119f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016119eb90612712565b60405180910390fd5b50565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051611ac091906123aa565b600060405180830381855afa9150503d8060008114611afb576040519150601f19603f3d011682016040523d82523d6000602084013e611b00565b606091505b50508091505080611b46576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611b3d9061277e565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1633604051602401611b8e91906122f4565b6040516020818303038152906040527f7ca81460000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051611c1891906123aa565b6000604051808303816000865af19150503d8060008114611c55576040519150601f19603f3d011682016040523d82523d6000602084013e611c5a565b606091505b50508091505080611ca0576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611c97906127ea565b60405180910390fd5b50565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051611d6c91906123aa565b600060405180830381855afa9150503d8060008114611da7576040519150601f19603f3d011682016040523d82523d6000602084013e611dac565b606091505b50508091505080611df2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611de990612856565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff1633604051602401611e3a91906122f4565b6040516020818303038152906040527f7ca81460000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff8381831617835250505050604051611ec491906123aa565b6000604051808303816000865af19150503d8060008114611f01576040519150601f19603f3d011682016040523d82523d6000602084013e611f06565b606091505b50508091505080611f4c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401611f43906128c2565b60405180910390fd5b50565b60007f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff166040516024016040516020818303038152906040527f537d22bd000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161201891906123aa565b600060405180830381855afa9150503d8060008114612053576040519150601f19603f3d011682016040523d82523d6000602084013e612058565b606091505b5050809150508061209e576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161209590612954565b60405180910390fd5b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff16336040516024016120e691906122f4565b6040516020818303038152906040527f7ca81460000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff19166020820180517bffffffffffffffffffffffffffffffffffffffffffffffffffffffff838183161783525050505060405161217091906123aa565b6000604051808303816000865af19150503d80600081146121ad576040519150601f19603f3d011682016040523d82523d6000602084013e6121b2565b606091505b505080915050806121f8576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016121ef906129c0565b60405180910390fd5b50565b600080fd5b60008115159050919050565b61221581612200565b811461222057600080fd5b50565b6000813590506122328161220c565b92915050565b600080600080600060a08688031215612254576122536121fb565b5b600061226288828901612223565b955050602061227388828901612223565b945050604061228488828901612223565b935050606061229588828901612223565b92505060806122a688828901612223565b9150509295509295909350565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b60006122de826122b3565b9050919050565b6122ee816122d3565b82525050565b600060208201905061230960008301846122e5565b92915050565b61231881612200565b82525050565b6000602082019050612333600083018461230f565b92915050565b600081519050919050565b600081905092915050565b60005b8381101561236d578082015181840152602081019050612352565b60008484015250505050565b600061238482612339565b61238e8185612344565b935061239e81856020860161234f565b80840191505092915050565b60006123b68284612379565b915081905092915050565b600082825260208201905092915050565b7f547261696e2073656174206973206e6f7420617661696c61626c652e00000000600082015250565b6000612408601c836123c1565b9150612413826123d2565b602082019050919050565b60006020820190508181036000830152612437816123fb565b9050919050565b7f486f74656c20726f6f6d206973206e6f7420617661696c61626c652e00000000600082015250565b6000612474601c836123c1565b915061247f8261243e565b602082019050919050565b600060208201905081810360008301526124a381612467565b9050919050565b7f547261696e20626f6f6b696e67206661696c65642e0000000000000000000000600082015250565b60006124e06015836123c1565b91506124eb826124aa565b602082019050919050565b6000602082019050818103600083015261250f816124d3565b9050919050565b7f486f74656c20626f6f6b696e67206661696c65642e0000000000000000000000600082015250565b600061254c6015836123c1565b915061255782612516565b602082019050919050565b6000602082019050818103600083015261257b8161253f565b9050919050565b7f506c616e652073656174206973206e6f7420617661696c61626c652e00000000600082015250565b60006125b8601c836123c1565b91506125c382612582565b602082019050919050565b600060208201905081810360008301526125e7816125ab565b9050919050565b7f506c616e6520626f6f6b696e67206661696c65642e0000000000000000000000600082015250565b60006126246015836123c1565b915061262f826125ee565b602082019050919050565b6000602082019050818103600083015261265381612617565b9050919050565b7f54617869206973206e6f7420617661696c61626c652e00000000000000000000600082015250565b60006126906016836123c1565b915061269b8261265a565b602082019050919050565b600060208201905081810360008301526126bf81612683565b9050919050565b7f5461786920626f6f6b696e67206661696c65642e000000000000000000000000600082015250565b60006126fc6014836123c1565b9150612707826126c6565b602082019050919050565b6000602082019050818103600083015261272b816126ef565b9050919050565b7f5961636874206973206e6f7420617661696c61626c652e000000000000000000600082015250565b60006127686017836123c1565b915061277382612732565b602082019050919050565b600060208201905081810360008301526127978161275b565b9050919050565b7f596163687420626f6f6b696e67206661696c65642e0000000000000000000000600082015250565b60006127d46015836123c1565b91506127df8261279e565b602082019050919050565b60006020820190508181036000830152612803816127c7565b9050919050565b7f4d6f766965207469636b6574206973206e6f7420617661696c61626c652e0000600082015250565b6000612840601e836123c1565b915061284b8261280a565b602082019050919050565b6000602082019050818103600083015261286f81612833565b9050919050565b7f4d6f76696520626f6f6b696e67206661696c65642e0000000000000000000000600082015250565b60006128ac6015836123c1565b91506128b782612876565b602082019050919050565b600060208201905081810360008301526128db8161289f565b9050919050565b7f52657374617572616e74207461626c65206973206e6f7420617661696c61626c60008201527f652e000000000000000000000000000000000000000000000000000000000000602082015250565b600061293e6022836123c1565b9150612949826128e2565b604082019050919050565b6000602082019050818103600083015261296d81612931565b9050919050565b7f52657374617572616e7420626f6f6b696e67206661696c65642e000000000000600082015250565b60006129aa601a836123c1565b91506129b582612974565b602082019050919050565b600060208201905081810360008301526129d98161299d565b905091905056fea2646970667358221220a2c07397526f91dab15c9843da2c400b904f11d7cbb7d39e127512298fe52bd064736f6c63430008170033"

func main() {

	// Create test_statedb directory
	err := os.MkdirAll("./storage/test_statedb/", 0755)
	if err != nil {
		panic(err)
	}

	cfg, err := config.LoadDefault()
	if err != nil {
		panic(err)
	}

	// Generate address files with deterministic addresses
	err = GenerateDeterministicAddresses(cfg.ShardNum, cfg.TestAccountNum)
	if err != nil {
		panic(err)
	}

	// Generate contract addresses for all booking contracts
	numContracts := cfg.NumContracts
	if numContracts <= 0 {
		numContracts = 10 // default
	}

	err = GenerateHotelAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GenerateTrainAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GeneratePlaneAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GenerateTaxiAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GenerateYachtAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GenerateMovieAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GenerateRestaurantAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	err = GenerateTravelAddresses(numContracts)
	if err != nil {
		panic(err)
	}

	// Create storage for each shard
	for i := 0; i < cfg.ShardNum; i++ {
		CreateStorage(i)
	}
}

func GetAddresses() []*common.Address {
	addresses, err := os.ReadFile("./storage/address.txt")
	if err != nil {
		panic(err)
	}
	addressesInString := strings.Split(string(addresses), "\n")
	addressArray := make([]*common.Address, 0)
	for i := 0; i < len(addressesInString); i++ {
		addrStr := strings.TrimSpace(addressesInString[i])
		if addrStr == "" {
			continue
		}
		stringtoaddress := common.HexToAddress(addrStr)
		addressArray = append(addressArray, &stringtoaddress)
	}
	return addressArray
}

func GetHotelAddresses() []*common.Address {
	return getAddressesFromFile("./storage/hotelAddress.txt")
}

func GetTrainAddresses() []*common.Address {
	return getAddressesFromFile("./storage/trainAddress.txt")
}

func GetTravelAddresses() []*common.Address {
	return getAddressesFromFile("./storage/travelAddress.txt")
}

func GetPlaneAddresses() []*common.Address {
	return getAddressesFromFile("./storage/planeAddress.txt")
}

func GetTaxiAddresses() []*common.Address {
	return getAddressesFromFile("./storage/taxiAddress.txt")
}

func GetYachtAddresses() []*common.Address {
	return getAddressesFromFile("./storage/yachtAddress.txt")
}

func GetMovieAddresses() []*common.Address {
	return getAddressesFromFile("./storage/movieAddress.txt")
}

func GetRestaurantAddresses() []*common.Address {
	return getAddressesFromFile("./storage/restaurantAddress.txt")
}

func getAddressesFromFile(filename string) []*common.Address {
	addresses, err := os.ReadFile(filename)
	if err != nil {
		panic(err)
	}
	addressesInString := strings.Split(string(addresses), "\n")
	addressArray := make([]*common.Address, 0)
	for i := 0; i < len(addressesInString); i++ {
		addrStr := strings.TrimSpace(addressesInString[i])
		if addrStr == "" {
			continue
		}
		stringtoaddress := common.HexToAddress(addrStr)
		addressArray = append(addressArray, &stringtoaddress)
	}
	return addressArray
}

// GenerateDeterministicAddresses creates accounts with encoded prefixes
// Format: 0x[S][C][T]...remaining 37 hex chars...
// Where:
//
//	[S] = Shard number (0-7) - first hex digit directly determines the shard
//	[C] = Cross-shard flag (0 = local, 1 = cross-shard)
//	[T] = Transaction type (0 = send, 1 = contract)
//
// The shard is determined solely by the first hex digit for human readability.
func GenerateDeterministicAddresses(shardNum, accountsPerType int) error {
	file, err := os.Create("./storage/address.txt")
	if err != nil {
		return err
	}
	defer file.Close()

	accountIndex := 0
	for shard := 0; shard < shardNum; shard++ {
		for crossShard := 0; crossShard <= 1; crossShard++ { // 0=local, 1=cross
			for txType := 0; txType <= 1; txType++ { // 0=send, 1=contract
				for i := 0; i < accountsPerType; i++ {
					// Build prefix: shard + crossShard + txType (3 chars)
					prefix := fmt.Sprintf("%d%d%d", shard, crossShard, txType)
					// Generate deterministic middle based on index (37 hex chars to fill 40 total)
					middle := generateDeterministicMiddle(shard, crossShard, txType, i)
					addr := "0x" + prefix + middle
					if _, err := fmt.Fprintln(file, addr); err != nil {
						return err
					}
					accountIndex++
				}
			}
		}
	}
	fmt.Printf("Generated %d deterministic addresses\n", accountIndex)
	return nil
}

// generateDeterministicMiddle creates a deterministic 35-char hex middle for address
func generateDeterministicMiddle(shard, crossShard, txType, index int) string {
	seed := fmt.Sprintf("account-s%d-c%d-t%d-i%d", shard, crossShard, txType, index)
	hash := sha256.Sum256([]byte(seed))
	// Take 18 bytes (36 hex chars) + 1 nibble = 37 hex chars total
	// Address format: 0x + 3 prefix + 37 middle = 42 chars (40 hex digits)
	return fmt.Sprintf("%x0", hash[:18])
}

// Legacy function for backward compatibility
func GenerateAddresses() error {
	file, err := os.Create("./storage/address.txt")
	if err != nil {
		return err
	}
	defer file.Close()

	cfg, err := config.LoadDefault()
	if err != nil {
		return err
	}

	for i := 0; i < cfg.TestAccountNum; i++ {
		seed := fmt.Sprintf("shard-test-account-%d", i)
		hash := sha256.Sum256([]byte(seed))
		addr := common.BytesToAddress(hash[:])
		if _, err := fmt.Fprintln(file, addr.Hex()); err != nil {
			return err
		}
	}
	return nil
}

func GenerateHotelAddresses(numContracts int) error {
	return generateContractAddresses("./storage/hotelAddress.txt", "hotel", numContracts)
}

func GenerateTrainAddresses(numContracts int) error {
	return generateContractAddresses("./storage/trainAddress.txt", "train", numContracts)
}

func GeneratePlaneAddresses(numContracts int) error {
	return generateContractAddresses("./storage/planeAddress.txt", "plane", numContracts)
}

func GenerateTaxiAddresses(numContracts int) error {
	return generateContractAddresses("./storage/taxiAddress.txt", "taxi", numContracts)
}

func GenerateYachtAddresses(numContracts int) error {
	return generateContractAddresses("./storage/yachtAddress.txt", "yacht", numContracts)
}

func GenerateMovieAddresses(numContracts int) error {
	return generateContractAddresses("./storage/movieAddress.txt", "movie", numContracts)
}

func GenerateRestaurantAddresses(numContracts int) error {
	return generateContractAddresses("./storage/restaurantAddress.txt", "restaurant", numContracts)
}

func GenerateTravelAddresses(numContracts int) error {
	return generateContractAddresses("./storage/travelAddress.txt", "travel", numContracts)
}

func generateContractAddresses(filename, contractType string, numContracts int) error {
	file, err := os.Create(filename)
	if err != nil {
		return err
	}
	defer file.Close()

	cfg, err := config.LoadDefault()
	if err != nil {
		return err
	}

	// Generate contracts: half local (crossShard=0) and half cross-shard (crossShard=1)
	// Format: 0x[S][C][T]...middle 37 chars...
	// where:
	//   [S] = shard (0-7) - first hex digit directly determines the shard
	//   [C] = cross-shard flag (0=local, 1=cross-shard)
	//   [T] = 1 (contract)
	for i := 0; i < numContracts; i++ {
		shard := i % cfg.ShardNum
		// First half of contracts per shard are local, second half are cross-shard
		crossShard := 0
		if i >= numContracts/2 {
			crossShard = 1
		}
		// Prefix: shard + cross + contract(1)
		prefix := fmt.Sprintf("%d%d1", shard, crossShard)
		middle := generateContractMiddle(contractType, shard, i)
		addr := "0x" + prefix + middle
		if _, err := fmt.Fprintln(file, addr); err != nil {
			return err
		}
	}
	return nil
}

// generateContractMiddle creates a deterministic 37-char hex middle for contract address
func generateContractMiddle(contractType string, shard, index int) string {
	seed := fmt.Sprintf("contract-%s-s%d-i%d", contractType, shard, index)
	hash := sha256.Sum256([]byte(seed))
	// Take 18 bytes (36 hex chars) + fixed nibble = 37 hex chars
	// Address format: 0x + 3 prefix + 37 middle = 42 chars (40 hex digits)
	return fmt.Sprintf("%x0", hash[:18])
}

func CreateStorage(shardID int) {
	cfg, err := config.LoadDefault()
	if err != nil {
		panic(err)
	}

	leveldb, err := leveldb.New("./storage/test_statedb/"+strconv.Itoa(shardID), 128, 1024, "", false)
	if err != nil {
		panic(err)
	}

	rdb := rawdb.NewDatabase(leveldb)
	tdb := triedb.NewDatabase(rdb, nil)
	sdb := state.NewDatabase(tdb, nil)
	stateDB, err := state.New(types.EmptyRootHash, sdb)

	if err != nil {
		panic(err)
	}

	addresses := GetAddresses()
	for _, address := range addresses {
		// Shard is determined by first hex digit after 0x
		// Parse hex digit: '0'-'9' -> 0-9, 'a'-'f' -> 10-15, 'A'-'F' -> 10-15
		addrHex := address.Hex()[2:] // Remove "0x"
		firstChar := addrHex[0]
		var shardDigit int
		if firstChar >= '0' && firstChar <= '9' {
			shardDigit = int(firstChar - '0')
		} else if firstChar >= 'a' && firstChar <= 'f' {
			shardDigit = int(firstChar - 'a' + 10)
		} else if firstChar >= 'A' && firstChar <= 'F' {
			shardDigit = int(firstChar - 'A' + 10)
		}
		if shardDigit == shardID {
			stateDB.SetBalance(*address, uint256.NewInt(1e18+200000), tracing.BalanceChangeUnspecified)
			stateDB.SetNonce(*address, 0, tracing.NonceChangeUnspecified)
		}
	}

	// Chain config with Cancun enabled (for MCOPY opcode support in Solidity 0.8.23+)
	chainCfg := &params.ChainConfig{
		ChainID:             big.NewInt(1337),
		HomesteadBlock:      big.NewInt(0),
		EIP150Block:         big.NewInt(0),
		EIP155Block:         big.NewInt(0),
		EIP158Block:         big.NewInt(0),
		ByzantiumBlock:      big.NewInt(0),
		ConstantinopleBlock: big.NewInt(0),
		PetersburgBlock:     big.NewInt(0),
		IstanbulBlock:       big.NewInt(0),
		BerlinBlock:         big.NewInt(0),
		LondonBlock:         big.NewInt(0),
		ShanghaiTime:        new(uint64), // Enable Shanghai at time 0
		CancunTime:          new(uint64), // Enable Cancun at time 0 (for MCOPY)
	}

	// Create EVM instance for contract deployment
	blockContext := vm.BlockContext{
		CanTransfer: func(db vm.StateDB, addr common.Address, amount *uint256.Int) bool {
			return db.GetBalance(addr).Cmp(amount) >= 0
		},
		Transfer: func(db vm.StateDB, from, to common.Address, amount *uint256.Int) {
			db.SubBalance(from, amount, tracing.BalanceChangeTransfer)
			db.AddBalance(to, amount, tracing.BalanceChangeTransfer)
		},
		GetHash:     func(n uint64) common.Hash { return common.Hash{} },
		Coinbase:    common.Address{},
		BlockNumber: big.NewInt(0),
		Time:        0,
		Difficulty:  big.NewInt(0),
		GasLimit:    100000000,
		BaseFee:     big.NewInt(0),
		Random:      &common.Hash{},
	}
	evm := vm.NewEVM(blockContext, stateDB, chainCfg, vm.Config{})
	evm.TxContext = vm.TxContext{
		Origin:   common.Address{},
		GasPrice: big.NewInt(0),
	}

	// Deployer account for EVM.Create
	deployer := common.HexToAddress("0x9999999999999999999999999999999999999999")
	stateDB.SetBalance(deployer, uint256.NewInt(1e18), tracing.BalanceChangeUnspecified)

	// Set contract accounts using EVM.Create to get runtime bytecode
	// Required contracts (train, hotel)
	setContractAccounts(evm, stateDB, deployer, GetHotelAddresses(), cfg.ShardNum, shardID, "hotel")
	setContractAccounts(evm, stateDB, deployer, GetTrainAddresses(), cfg.ShardNum, shardID, "train")

	// Optional contracts (plane, taxi, yacht, movie, restaurant)
	setContractAccounts(evm, stateDB, deployer, GetPlaneAddresses(), cfg.ShardNum, shardID, "plane")
	setContractAccounts(evm, stateDB, deployer, GetTaxiAddresses(), cfg.ShardNum, shardID, "taxi")
	setContractAccounts(evm, stateDB, deployer, GetYachtAddresses(), cfg.ShardNum, shardID, "yacht")
	setContractAccounts(evm, stateDB, deployer, GetMovieAddresses(), cfg.ShardNum, shardID, "movie")
	setContractAccounts(evm, stateDB, deployer, GetRestaurantAddresses(), cfg.ShardNum, shardID, "restaurant")

	// TravelAgency (depends on all others)
	setContractAccounts(evm, stateDB, deployer, GetTravelAddresses(), cfg.ShardNum, shardID, "travel")

	fmt.Printf("Set Account for shard %v\n", shardID)
	// EVM Create fn / stateDB 가지고 놀기
	root, err := stateDB.Commit(0, true, false)
	if err != nil {
		panic(err)
	}
	fmt.Printf("Commit Root: %v\n", root)

	file, err := os.Create(fmt.Sprintf("./storage/test_statedb/shard%v_root.txt", shardID))
	if err != nil {
		panic(err)
	}
	defer file.Close()

	if _, err = file.WriteString(root.Hex()); err != nil {
		panic(err)
	}

	if err := tdb.Commit(root, false); err != nil {
		panic(err)
	}
	leveldb.Close()

}

func setContractAccounts(evm *vm.EVM, stateDB *state.StateDB, deployer common.Address, addresses []*common.Address, numShards, shardID int, contractType string) {
	// Load all addresses once for pairing (only for TravelAgency)
	var allTrainAddrs, allHotelAddrs, allTravelAddrs []*common.Address
	var allPlaneAddrs, allTaxiAddrs, allYachtAddrs, allMovieAddrs, allRestaurantAddrs []*common.Address
	if contractType == "travel" {
		allTrainAddrs = GetTrainAddresses()
		allHotelAddrs = GetHotelAddresses()
		allTravelAddrs = GetTravelAddresses()
		allPlaneAddrs = GetPlaneAddresses()
		allTaxiAddrs = GetTaxiAddresses()
		allYachtAddrs = GetYachtAddresses()
		allMovieAddrs = GetMovieAddresses()
		allRestaurantAddrs = GetRestaurantAddresses()
	}

	// Get the creation bytecode for this contract type
	var creationBytecode []byte
	switch contractType {
	case "train":
		creationBytecode = common.FromHex(trainBookingBytecode)
	case "hotel":
		creationBytecode = common.FromHex(hotelBookingBytecode)
	case "plane", "taxi", "yacht", "movie", "restaurant":
		creationBytecode = common.FromHex(genericBookingBytecode)
	case "travel":
		creationBytecode = common.FromHex(travelAgencyBytecode)
	}

	for _, address := range addresses {
		// Shard determined by first hex digit after 0x
		addrHex := address.Hex()[2:] // Remove "0x"
		shardDigit := int(addrHex[0] - '0')
		if shardDigit%numShards != shardID {
			continue
		}

		var deployCode []byte
		if contractType == "travel" {
			// Find index of this TravelAgency address
			index := -1
			for i, travelAddr := range allTravelAddrs {
				if travelAddr.Hex() == address.Hex() {
					index = i
					break
				}
			}
			if index == -1 || index >= len(allTrainAddrs) || index >= len(allHotelAddrs) {
				panic(fmt.Sprintf("No matching Train/Hotel for TravelAgency at index %d", index))
			}
			// Get deploy code with constructor arguments (all 7 addresses)
			trainAddrHex := allTrainAddrs[index].Hex()[2:] // Remove "0x" prefix
			hotelAddrHex := allHotelAddrs[index].Hex()[2:]
			planeAddrHex := getAddressOrZero(allPlaneAddrs, index)
			taxiAddrHex := getAddressOrZero(allTaxiAddrs, index)
			yachtAddrHex := getAddressOrZero(allYachtAddrs, index)
			movieAddrHex := getAddressOrZero(allMovieAddrs, index)
			restaurantAddrHex := getAddressOrZero(allRestaurantAddrs, index)

			deployCode = GetDeployCode("travel", []byte(common.Bytes2Hex(creationBytecode)),
				trainAddrHex, hotelAddrHex, planeAddrHex, taxiAddrHex, yachtAddrHex, movieAddrHex, restaurantAddrHex)
		} else {
			deployCode = GetDeployCode(contractType, []byte(common.Bytes2Hex(creationBytecode)), "", "", "", "", "", "", "")
		}

		// Execute EVM.Create to run constructor and get runtime bytecode
		runtimeCode, _, _, err := evm.Create(deployer, deployCode, 10000000, uint256.NewInt(0))
		if err != nil {
			panic(fmt.Sprintf("Failed to create %s contract: %v", contractType, err))
		}

		// Set the runtime bytecode to our predetermined address
		stateDB.SetCode(*address, runtimeCode, tracing.CodeChangeUnspecified)
		stateDB.SetNonce(*address, 1, tracing.NonceChangeUnspecified)

		fmt.Printf("Shard %d: Deployed %s contract at %s\n", shardID, contractType, address.Hex())
	}
}

func getAddressOrZero(addrs []*common.Address, index int) string {
	if index < len(addrs) {
		return addrs[index].Hex()[2:] // Remove "0x" prefix
	}
	return "0000000000000000000000000000000000000000" // Zero address
}

func GetDeployCode(contractName string, code []byte, arg1, arg2, arg3, arg4, arg5, arg6, arg7 string) []byte {
	switch contractName {
	case "train", "hotel", "plane", "taxi", "yacht", "movie", "restaurant":
		// These contracts have no constructor arguments
		return hexutil.MustDecode("0x" + string(code))
	case "travel":
		// Travel: 생성자가 7개 주소 받음 (train, hotel, plane, taxi, yacht, movie, restaurant)
		// ABI 인코딩: 주소는 32바이트(64 hex)로 패딩 필요
		return hexutil.MustDecode("0x" + string(code) +
			"000000000000000000000000" + arg1 + // Train 주소 (32바이트 패딩)
			"000000000000000000000000" + arg2 + // Hotel 주소 (32바이트 패딩)
			"000000000000000000000000" + arg3 + // Plane 주소 (32바이트 패딩)
			"000000000000000000000000" + arg4 + // Taxi 주소 (32바이트 패딩)
			"000000000000000000000000" + arg5 + // Yacht 주소 (32바이트 패딩)
			"000000000000000000000000" + arg6 + // Movie 주소 (32바이트 패딩)
			"000000000000000000000000" + arg7) // Restaurant 주소 (32바이트 패딩)
	}
	return nil
}
